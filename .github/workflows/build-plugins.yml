name: Build Plugins
on:
  push:
    tags:
      - "plugin@*"
  workflow_dispatch:
    inputs:
      plugin_name:
        description: "æŒ‡å®šè¦æ„å»ºçš„æ’ä»¶åç§°ï¼ˆç•™ç©ºåˆ™æ„å»ºå…¨éƒ¨ï¼‰"
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      issues: write
      pull-requests: write
    env:
      GO111MODULE: "on"
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.25.1
          check-latest: true

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Install dependencies
        run: |
          docker pull crazymax/xgo:latest
          go install github.com/crazy-max/xgo@latest
          sudo apt update
          sudo apt install -y upx

          # éªŒè¯å¤šæ¶æ„æ”¯æŒ
          echo "ğŸ” æ£€æŸ¥å¤šæ¶æ„æ”¯æŒ..."
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          docker buildx ls

          # æµ‹è¯• ARM64 æ¨¡æ‹Ÿ
          echo "ğŸ§ª æµ‹è¯• ARM64 æ¨¡æ‹Ÿ..."
          docker run --rm --platform linux/arm64 alpine:latest uname -a || echo "âš ï¸  ARM64 æ¨¡æ‹Ÿä¸å¯ç”¨"

      - name: Build plugins
        working-directory: backend
        run: |
          # éªŒè¯å·¥å…·é“¾
          echo "ğŸ” æ£€æŸ¥æ„å»ºå·¥å…·..."
          which xgo || echo "xgo æœªæ‰¾åˆ°"
          which docker || echo "docker æœªæ‰¾åˆ°"
          go version

          # ä¿®æ”¹è„šæœ¬æƒé™
          chmod +x build-plugin-xgo.sh
          chmod +x build-plugin-musl.sh

          # æ„å»º glibc ç‰ˆæœ¬ï¼ˆä½¿ç”¨ xgoï¼‰
          echo "ğŸš€ æ­¥éª¤ 1/2: æ„å»º glibc ç‰ˆæœ¬..."
          if [ -n "${{ github.event.inputs.plugin_name }}" ]; then
            ./build-plugin-xgo.sh "${{ github.event.inputs.plugin_name }}"
          else
            ./build-plugin-xgo.sh
          fi

          # æ„å»º musl ç‰ˆæœ¬ï¼ˆä½¿ç”¨æ–°çš„ä¸“ç”¨è„šæœ¬ï¼‰
          echo "ğŸš€ æ­¥éª¤ 2/2: æ„å»º musl ç‰ˆæœ¬..."

          # è®¾ç½® Docker ç¯å¢ƒå˜é‡ä»¥æ”¯æŒå¤šæ¶æ„
          export DOCKER_CLI_EXPERIMENTAL=enabled
          export DOCKER_BUILDKIT=1

          if [ -n "${{ github.event.inputs.plugin_name }}" ]; then
            ./build-plugin-musl.sh "${{ github.event.inputs.plugin_name }}"
          else
            ./build-plugin-musl.sh
          fi

          # æ˜¾ç¤ºæ„å»ºç»“æœ
          echo "ğŸ“Š æ„å»ºç»“æœ:"
          find plugins -name "*.so" -type f | sort

      - name: Package plugins
        working-directory: backend/plugins
        run: |
          # ä¸ºæ¯ä¸ªæ’ä»¶åˆ›å»ºå‹ç¼©åŒ…
          for plugin_dir in */; do
            plugin_name=${plugin_dir%/}
            echo "æ­£åœ¨æ‰“åŒ…æ’ä»¶: $plugin_name"
            
            # åˆ›å»ºä¸´æ—¶ç›®å½•
            mkdir -p "temp_$plugin_name"
            
            # å¤åˆ¶æ’ä»¶æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½• (åŒ…æ‹¬ glibc å’Œ musl ç‰ˆæœ¬)
            cp "$plugin_name"/plugin-*.so "temp_$plugin_name/" 2>/dev/null || true
            cp "$plugin_name"/setting.json "temp_$plugin_name/" 2>/dev/null || true
            
            # æ˜¾ç¤ºå¤åˆ¶çš„æ–‡ä»¶
            echo "æ’ä»¶ $plugin_name çš„æ–‡ä»¶:"
            ls -la "$plugin_name"/plugin-*.so 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ° .so æ–‡ä»¶"
            
            # åˆ›å»ºå‹ç¼©åŒ…
            if [ -d "temp_$plugin_name" ] && [ "$(ls -A temp_$plugin_name)" ]; then
              tar -czf "${plugin_name}.tar.gz" -C "temp_$plugin_name" .
              echo "æˆåŠŸåˆ›å»ºå‹ç¼©åŒ…: ${plugin_name}.tar.gz"
            fi
            
            # æ¸…ç†ä¸´æ—¶ç›®å½•
            rm -rf "temp_$plugin_name"
          done

          # åˆ—å‡ºåˆ›å»ºçš„å‹ç¼©åŒ…
          ls -la *.tar.gz

      - name: Debug environment
        run: |
          echo "GITHUB_REF: $GITHUB_REF"
          echo "GITHUB_REF_NAME: $GITHUB_REF_NAME"
          echo "GITHUB_EVENT_NAME: $GITHUB_EVENT_NAME"
          echo "GITHUB_SHA: $GITHUB_SHA"

      - name: Extract version from tag
        id: extract_version
        run: |
          # ä»tagä¸­æå–ç‰ˆæœ¬å· (plugin@1.0.0 -> 1.0.0)
          VERSION=${GITHUB_REF#refs/tags/plugin@}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "æå–çš„ç‰ˆæœ¬å·: $VERSION"
          echo "å®Œæ•´ref: $GITHUB_REF"
          echo "refåç§°: $GITHUB_REF_NAME"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "æ’ä»¶åŒ… v${{ steps.extract_version.outputs.version }}"
          body: |
            ## æ’ä»¶åŒ…å‘å¸ƒ v${{ steps.extract_version.outputs.version }}

            æ­¤ç‰ˆæœ¬åŒ…å«ä»¥ä¸‹æ’ä»¶çš„ç¼–è¯‘æ–‡ä»¶ï¼š

            ### åŒ…å«çš„æ’ä»¶
            - **glibc ç‰ˆæœ¬**: é€‚ç”¨äºæ ‡å‡† Linux å‘è¡Œç‰ˆå’Œ macOS
              - `plugin-linux-amd64.so`, `plugin-linux-arm64.so`
              - `plugin-darwin-amd64.so`, `plugin-darwin-arm64.so`
            - **musl ç‰ˆæœ¬**: é€‚ç”¨äº Alpine Linux ç­‰åŸºäº musl çš„å®¹å™¨
              - `plugin-linux-amd64-musl.so`, `plugin-linux-arm64-musl.so`
            - æ’ä»¶é…ç½®æ–‡ä»¶ `setting.json`

            ### ä½¿ç”¨æ–¹æ³•
            1. ä¸‹è½½å¯¹åº”æ’ä»¶çš„å‹ç¼©åŒ…
            2. è§£å‹åˆ°æ’ä»¶ç›®å½•
            3. é‡å¯æœåŠ¡åŠ è½½æ’ä»¶

            ### æ³¨æ„äº‹é¡¹
            - **glibc ç‰ˆæœ¬**: é€‚ç”¨äº Ubuntuã€CentOSã€Debian ç­‰æ ‡å‡† Linux å‘è¡Œç‰ˆå’Œ macOS
            - **musl ç‰ˆæœ¬**: ä¸“ä¸º Alpine Linux å®¹å™¨è®¾è®¡ï¼Œæ›´å°æ›´å®‰å…¨
            - è¯·æ ¹æ®æ‚¨çš„ç³»ç»Ÿç¯å¢ƒé€‰æ‹©å¯¹åº”çš„ `.so` æ–‡ä»¶
            - ç¡®ä¿ `setting.json` é…ç½®æ­£ç¡®
          files: backend/plugins/*.tar.gz
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
