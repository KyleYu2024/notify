name: Build Plugins

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      plugin_name:
        description: "æŒ‡å®šè¦æ„å»ºçš„æ’ä»¶åç§°ï¼ˆç•™ç©ºåˆ™æ„å»ºå…¨éƒ¨ï¼‰"
        required: false
        type: string
      platforms:
        description: "ç›®æ ‡å¹³å°ï¼ˆç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šdarwin-amd64,linux-amd64ï¼‰"
        required: false
        default: "all"
        type: string
      debug_mode:
        description: "å¯ç”¨Debugæ¨¡å¼"
        required: false
        default: false
        type: boolean

env:
  GO_VERSION: "1.25.1"

jobs:
  build-plugins:
    name: Build Plugins - ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Linux (AMD64 + ARM64)"
            os: ubuntu-latest
            platforms: "linux-amd64,linux-arm64"
          - name: "macOS (Intel + Apple Silicon)"
            os: macos-latest
            platforms: "darwin-amd64,darwin-arm64"

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Goç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true

      - name: æ£€æŸ¥Goç‰ˆæœ¬
        run: go version

      - name: å®‰è£…æ„å»ºä¾èµ– (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: è®¾ç½®Docker (å¦‚æœéœ€è¦)
        if: runner.os == 'Linux' || runner.os == 'macOS'
        run: |
          if command -v docker >/dev/null 2>&1; then
            echo "Dockerå·²å®‰è£…"
            docker --version
          else
            echo "Dockeræœªå®‰è£…ï¼ŒæŸäº›äº¤å‰ç¼–è¯‘å¯èƒ½ä¼šå¤±è´¥"
          fi

      - name: ç¼“å­˜Goæ¨¡å—
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('backend/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: å®‰è£…æ’ä»¶ä¾èµ–
        working-directory: backend
        run: |
          # ä¸ºæ¯ä¸ªæ’ä»¶å®‰è£…ä¾èµ–
          find plugins -name "go.mod" -execdir go mod download \;

      - name: æ„å»ºæ’ä»¶
        working-directory: backend
        run: |
          chmod +x build-plugin.sh

          # è®¾ç½®æ„å»ºå‚æ•°
          BUILD_ARGS=""

          # Debugæ¨¡å¼
          if [[ "${{ github.event.inputs.debug_mode }}" == "true" ]]; then
            BUILD_ARGS="$BUILD_ARGS --debug"
          fi

          # å¹³å°å‚æ•° - ä¼˜å…ˆä½¿ç”¨æ‰‹åŠ¨æŒ‡å®šçš„å¹³å°ï¼Œå¦åˆ™ä½¿ç”¨çŸ©é˜µä¸­çš„å¹³å°
          PLATFORMS="${{ github.event.inputs.platforms }}"
          if [[ -z "$PLATFORMS" || "$PLATFORMS" == "all" ]]; then
            PLATFORMS="${{ matrix.platforms }}"
          fi
          BUILD_ARGS="$BUILD_ARGS --platform $PLATFORMS"

          # æ’ä»¶åç§°
          PLUGIN_NAME="${{ github.event.inputs.plugin_name }}"

          # æ‰§è¡Œæ„å»º
          echo "ğŸ”§ æ‰§è¡Œæ„å»ºå‘½ä»¤: ./build-plugin.sh $BUILD_ARGS $PLUGIN_NAME"
          echo "ğŸ“‹ ç›®æ ‡å¹³å°: $PLATFORMS"
          echo "ğŸ¯ ç›®æ ‡æ’ä»¶: ${PLUGIN_NAME:-'å…¨éƒ¨æ’ä»¶'}"
          echo "ğŸ”¨ æ„å»ºæ¨¡å¼: ${{ github.event.inputs.debug_mode == 'true' && 'Debug' || 'Release' }}"
          echo ""

          ./build-plugin.sh $BUILD_ARGS $PLUGIN_NAME

      - name: æ”¶é›†æ„å»ºäº§ç‰©
        id: collect-artifacts
        working-directory: backend
        run: |
          mkdir -p ../artifacts

          # æŸ¥æ‰¾æ‰€æœ‰æ„å»ºçš„æ’ä»¶æ–‡ä»¶
          find plugins -name "plugin-*.so" -type f | while read file; do
            # æå–æ’ä»¶åå’Œå¹³å°ä¿¡æ¯
            plugin_dir=$(dirname "$file")
            plugin_name=$(basename "$plugin_dir")
            filename=$(basename "$file")
            
            # åˆ›å»ºç›®æ ‡ç›®å½•
            target_dir="../artifacts/$plugin_name"
            mkdir -p "$target_dir"
            
            # å¤åˆ¶æ–‡ä»¶
            cp "$file" "$target_dir/"
            echo "æ”¶é›†: $file -> $target_dir/$filename"
          done

          # æ£€æŸ¥æ˜¯å¦æœ‰æ„å»ºäº§ç‰©
          if [ -d "../artifacts" ] && [ "$(ls -A ../artifacts)" ]; then
            echo "has_artifacts=true" >> $GITHUB_OUTPUT
            echo "æ„å»ºäº§ç‰©æ”¶é›†å®Œæˆ"
            ls -la ../artifacts/
          else
            echo "has_artifacts=false" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰æ‰¾åˆ°æ„å»ºäº§ç‰©"
          fi

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        if: steps.collect-artifacts.outputs.has_artifacts == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: plugins-${{ runner.os }}-${{ github.run_number }}
          path: artifacts/
          retention-days: 30
          if-no-files-found: warn

      - name: æ˜¾ç¤ºæ„å»ºæ‘˜è¦
        if: always()
        working-directory: backend
        run: |
          echo "## ğŸ”§ æ’ä»¶æ„å»ºæ‘˜è¦ - ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**è¿è¡Œç¯å¢ƒ**: ${{ runner.os }}" >> $GITHUB_STEP_SUMMARY
          echo "**ç›®æ ‡å¹³å°**: ${{ matrix.platforms }}" >> $GITHUB_STEP_SUMMARY
          echo "**Goç‰ˆæœ¬**: ${{ env.GO_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ„å»ºæ¨¡å¼**: ${{ github.event.inputs.debug_mode == 'true' && 'Debug' || 'Release' }}" >> $GITHUB_STEP_SUMMARY
          echo "**æŒ‡å®šæ’ä»¶**: ${{ github.event.inputs.plugin_name || 'å…¨éƒ¨æ’ä»¶' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if find plugins -name "plugin-*.so" -type f > /dev/null 2>&1; then
            echo "### âœ… æ„å»ºæˆåŠŸçš„æ’ä»¶:" >> $GITHUB_STEP_SUMMARY
            find plugins -name "plugin-*.so" -type f | while read file; do
              plugin_name=$(basename $(dirname "$file"))
              filename=$(basename "$file")
              size=$(ls -lh "$file" | awk '{print $5}')
              echo "- **$plugin_name**: $filename ($size)" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "### âŒ æ²¡æœ‰æˆåŠŸæ„å»ºçš„æ’ä»¶" >> $GITHUB_STEP_SUMMARY
          fi

  summary:
    name: æ„å»ºæ‘˜è¦
    runs-on: ubuntu-latest
    needs: build-plugins
    if: always()
    steps:
      - name: è¾“å‡ºæ„å»ºç»“æœ
        run: |
          echo "## ğŸš€ æ’ä»¶æ„å»ºå®Œæˆ" 
          echo ""
          if [[ "${{ needs.build-plugins.result }}" == "success" ]]; then
            echo "âœ… **çŠ¶æ€**: æ‰€æœ‰å¹³å°æ„å»ºæˆåŠŸ"
            echo "ğŸ¯ **ç›®æ ‡**: ${{ github.event.inputs.plugin_name || 'å…¨éƒ¨æ’ä»¶' }}"
            echo "ğŸ—ï¸ **å¹³å°**: æ‰€æœ‰æ”¯æŒçš„å¹³å°"
            echo "ğŸ“¦ **äº§ç‰©**: å·²ä¸Šä¼ è‡³ Actions Artifacts"
          else
            echo "âŒ **çŠ¶æ€**: æ„å»ºå¤±è´¥"
            echo "ğŸ” **å»ºè®®**: è¯·æ£€æŸ¥ä¸Šæ–¹çš„æ„å»ºæ—¥å¿—ä»¥è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
            exit 1
          fi
