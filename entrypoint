#!/bin/sh

# 设置默认配置文件路径
: ${CONFIG_FILE:=config/config.yaml}

echo "Using config file: $CONFIG_FILE"

# 从配置文件路径中提取目录
CONFIG_DIR=$(dirname "$CONFIG_FILE")

# 确保配置目录存在
if [ ! -d "$CONFIG_DIR" ]; then
    echo "Creating config directory: $CONFIG_DIR"
    mkdir -p "$CONFIG_DIR"
fi

# 如果配置文件不存在，创建默认配置文件
if [ ! -f "$CONFIG_FILE" ]; then
    echo "Creating default config file: $CONFIG_FILE"
    cat > "$CONFIG_FILE" << 'EOF'
# 默认配置文件


notifiers: {}

templates: {}

notification_apps: {}
EOF
    # 设置配置文件权限
    chmod 644 "$CONFIG_FILE"
    echo "Default config file created successfully"
fi

# 检查并设置PGID和PUID的默认值
: ${PGID:=1000}
: ${PUID:=1000}

echo "Setting PGID to $PGID and PUID to $PUID"

# 修改组ID
if [ "$PGID" != "1000" ]; then
    groupmod -o -g "${PGID}" notify
fi

# 修改用户ID
if [ "$PUID" != "1000" ]; then
    usermod -o -u "${PUID}" notify
fi

chown -R notify:notify \
    "${HOME}" \
    /app \
    "$CONFIG_DIR" 

# 设置默认umask
: ${UMASK:=022}
umask "${UMASK}"

echo "Starting notification service as notify user (${PUID}:${PGID})"

# 按需同步内置插件到可写目录
SEED_DIR="/opt/plugins-dist"
TARGET_DIR="${PLUGINS_DIR:-/app/plugins}"
if [ -d "$SEED_DIR" ]; then
    if [ ! -d "$TARGET_DIR" ]; then
        echo "Creating plugins directory: $TARGET_DIR"
        mkdir -p "$TARGET_DIR"
        chown -R notify:notify "$TARGET_DIR"
    fi

    echo "Seeding plugins from $SEED_DIR to $TARGET_DIR (missing only)"
    for d in "$SEED_DIR"/*; do
        [ -d "$d" ] || continue
        name=$(basename "$d")
        src="$d"
        dst="$TARGET_DIR/$name"
        mkdir -p "$dst"
        # 仅复制 setting.json 与 *.so，且仅在目标缺失时复制
        for f in "$src"/setting.json "$src"/*.so; do
            if [ -f "$f" ]; then
                base=$(basename "$f")
                if [ ! -f "$dst/$base" ]; then
                    echo "  -> install $name/$base"
                    cp "$f" "$dst/"
                    chown notify:notify "$dst/$base"
                    chmod 644 "$dst/$base"
                fi
            fi
        done
    done
fi

# 启动后端服务
exec gosu notify:notify /app/notify
